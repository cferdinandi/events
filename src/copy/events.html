<!DOCTYPE html>
<html>
<head>
	<title>Events.js</title>
	<style type="text/css">
		body {
			background-color: #272727;
		}
	</style>
</head>
<body>

	<button class="btn1">Button 1</button>
	<button class="btn2"><span>Button 2</span></button>

	.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>
	.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>
	.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>
	.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>
	.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>
	.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>
	.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>
	.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>
	.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>
	.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>
	.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>
	.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>.<br>

	<script type="text/javascript">
		var events = (function () {

			'use strict';

			//
			// Variables
			//

			var publicAPIs = {};
			var activeEvents = {};


			//
			// Methods
			//

			/**
			 * Get the index for the listener
			 * @param  {Array}   arr      The listeners for an event
			 * @param  {Array}   listener The listener details
			 * @return {Integer}          The index of the listener
			 */
			var getIndex = function (arr, listener) {
				for (var i = 0; i < arr.length; i++) {
					if (
						arr[i].selector === listener[1] &&
						arr[i].callback.toString() === listener[2].toString() &&
						arr[i].within === listener[3]
					) return i;
				}
				return -1;
			};

			/**
			 * Check if the listener callback should run or not
			 * @param  {Node}    target   The event.target
			 * @param  {String}  selector The selector to check the target against
			 * @param  {Boolean} within   If true, pass elements within parent selector
			 * @return {Boolean}          If true, run listener
			 */
			var doRun = function (target, selector, within) {
				if (selector === 'document' || selector === 'window') {
					return true;
				} else if (within) {
					return target.closest(selector);
				}
				return target.matches(selector);
			};

			/**
			 * Handle listeners after event fires
			 */
			var eventHandler = function (event) {
				if (!activeEvents[event.type]) return;
				activeEvents[event.type].forEach(function (listener) {
					if (!doRun(event.target, listener.selector, listener.within)) return;
					listener.callback(event);
				});
			};

			/**
			 * Add an event
			 * @param  {String}   type     The event type or types (space separated)
			 * @param  {String}   selector The selector to run the event on
			 * @param  {Function} callback The function to run when the event fires
			 * @param  {Boolean}  within   If true, also run for elements within the selector
			 */
			publicAPIs.on = function (type, selector, callback, within) {

				// Make sure there's a selector and callback
				if (!selector || !callback) return;

				// Get types
				var types = type.split(' ');

				types.forEach(function (type) {

					// If not event of this type yet, setup
					if (!activeEvents[type]) {
						activeEvents[type] = [];
						window.addEventListener(type, eventHandler, true);
					}

					// Push to active events
					activeEvents[type].push({
						selector: selector,
						callback: callback,
						within: within
					});

				});

			};

			/**
			 * Remove an event
			 * @param  {String}   type     The event type or types (space separated)
			 * @param  {String}   selector The selector to remove the event from
			 * @param  {Function} callback The function to remove
			 * @param  {Boolean}  within   If true, also run for elements within the selector
			 */
			publicAPIs.off = function (type, selector, callback, within) {

				// Get types
				var types = type.split(' ');

				types.forEach(function (type) {

					// if event type doesn't exist, bail
					if (!activeEvents[type]) return;

					// If it's the last event of it's type, remove entirely
					if (activeEvents[type].length < 2 || !selector) {
						delete activeEvents[type];
						window.removeEventListener(type, eventHandler, true);
						return;
					}

					// Otherwise, remove event
					var index = getIndex(activeEvents[type], arguments);
					if (index < 0) return;
					activeEvents[type].splice(index, 1);

				});

			};

			/**
			 * Emit a custom event
			 * @param  {String} type   The event type
			 * @param  {Node}   elem   The element to attach the event to
			 * @param  {Object} detail Any details to pass along with the event
			 */
			publicAPIs.emit = function (type, elem, detail) {

				// Make sure there's an event type
				if (!type) return;

				// Variables
				elem = elem || window;
				detail = detail || {};

				// Create a new event
				var event = new CustomEvent(type, {
					bubbles: true,
					cancelable: true,
					detail: detail
				});

				// Dispatch the event
				elem.dispatchEvent(event);

			};


			//
			// Return public APIs
			//

			return publicAPIs;

		})();

		events.on('click scroll', 'document', function (event) {
			console.log(event.type);
		});

		events.on('click', '.btn1', function (event) {
			console.log(event.target);
		});

		events.on('click', '.btn2', function (event) {
			console.log(event.target);
		}, true);

		// events.on('scroll');
	</script>
</body>
</html>